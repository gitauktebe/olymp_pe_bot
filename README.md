# olymp_pe_bot

Telegram-–±–æ—Ç –¥–ª—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –≤–æ–ø—Ä–æ—Å–æ–≤ —Å –¥–Ω–µ–≤–Ω—ã–º–∏ –ª–∏–º–∏—Ç–∞–º–∏, —Ä–µ–π—Ç–∏–Ω–≥–æ–º –∏ –æ–ø–ª–∞—Ç–æ–π Telegram Stars.

## –°—Ç–µ–∫
- Python 3.12
- aiogram v3
- Supabase REST (`supabase-py`) + PostgreSQL

## –õ–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫

```bash
python3.12 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
cp .env.example .env
# –∑–∞–ø–æ–ª–Ω–∏—Ç–µ TELEGRAM_BOT_TOKEN –∏ –∫–ª—é—á–∏ Supabase
python src/bot.py
```

## –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ Docker

```bash
docker compose up -d --build
```

`.env` —Å–æ–∑–¥–∞—ë—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –≤—Ä—É—á–Ω—É—é –∏ –Ω–µ –∫–æ–º–º–∏—Ç–∏—Ç—Å—è –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π.

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
–°–º. `.env.example`.

## –ü–µ—Ä–≤–∏—á–Ω–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ë–î

1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –µ—Å—Ç—å —Ç–∞–±–ª–∏—Ü—ã:
   - `topics`, `questions`, `users`, `user_day`, `answers`, `subscriptions`, `admins`, `payments`
2. –ë–æ—Ç –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—ã—Ç–∞–µ—Ç—Å—è —Å–æ–∑–¥–∞—Ç—å `user_settings` —á–µ—Ä–µ–∑ Supabase SQL endpoint (`/pg/v1/query`).
3. –ï—Å–ª–∏ endpoint –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ SQL –≤—Ä—É—á–Ω—É—é –∏–∑ –ª–æ–≥–æ–≤ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ —Ç–∞–±–ª–∏—Ü—É:

```sql
create table if not exists public.user_settings (
  tg_id bigint primary key references public.users(tg_id) on delete cascade,
  mode text not null default 'random' check (mode in ('random','topic','difficulty')),
  topic_id bigint null references public.topics(id),
  difficulty smallint null check (difficulty between 1 and 5),
  paid_packs_available integer not null default 0,
  updated_at timestamptz not null default now()
);
```

## –°–∏–¥–∏—Ä–æ–≤–∞–Ω–∏–µ

```sql
-- Supabase SQL editor
\i scripts/seed_topics.sql
\i scripts/seed_questions.sql
```

## –ö–æ–º–∞–Ω–¥—ã
- `/start` ‚Äî —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –∑–∞–ø—É—Å–∫
- `/rating` ‚Äî —Ç–æ–ø-50
- `/stats` ‚Äî –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- `/my_payments` ‚Äî –º–æ–∏ –ø–æ–∫—É–ø–∫–∏ –∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∏
- `/admin` ‚Äî –∞–¥–º–∏–Ω-–º–µ–Ω—é (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ single-–≤–æ–ø—Ä–æ—Å–æ–≤, —Å–ø–∏—Å–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏/–ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–º–∞–º–∏)
- `/admin_stats`, `/grant_admin`, `/revoke_admin`, `/add_question`, `/toggle_question` ‚Äî —Å–ª—É–∂–µ–±–Ω—ã–µ –∞–¥–º–∏–Ω-–∫–æ–º–∞–Ω–¥—ã
- `/test_pay_pack10`, `/test_pay_unlimited30` ‚Äî —Ç–µ—Å—Ç–æ–≤—ã–µ –ø–ª–∞—Ç–µ–∂–∏ (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ `TEST_MODE=true` –∏ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤)

## –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–æ–≤
- –ß–µ—Ä–µ–∑ `/admin` ‚Üí ¬´‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å¬ª.
- FSM –¥–ª—è —Ç–∏–ø–∞ `single`: –≤—ã–±–æ—Ä —Ç–µ–º—ã (–∏–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π), –≤–≤–æ–¥ `prompt`, –≤–≤–æ–¥ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ `A/B/C/D`, –≤—ã–±–æ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –∫–Ω–æ–ø–∫–∞–º–∏, –ø—Ä–µ–≤—å—é –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.
- –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤ `questions` –∑–∞–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–æ–ª—è –Ω–æ–≤–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞: `prompt`, `type='single'`, `options` (jsonb), `answer` (jsonb `{"correct":[N]}`), `is_active=true`.
- –î–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –∑–∞–ø–æ–ª–Ω—è—é—Ç—Å—è legacy-–ø–æ–ª—è `text`, `option1..4`, `correct_option`.

## –†–∞–∑–¥–µ–ª ¬´üìö –í–æ–ø—Ä–æ—Å—ã¬ª
- –ü–∞–≥–∏–Ω–∞—Ü–∏—è –ø–æ 10 –≤–æ–ø—Ä–æ—Å–æ–≤.
- –§–∏–ª—å—Ç—Ä—ã –ø–æ —Ç–µ–º–µ –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (–≤—Å–µ / —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ / —Ç–æ–ª—å–∫–æ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ).
- –î–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ –¥–æ—Å—Ç—É–ø–Ω—ã –¥–µ–π—Å—Ç–≤–∏—è: ¬´üëÅ –û—Ç–∫—Ä—ã—Ç—å¬ª, ¬´‚úÖ/‚õî –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å¬ª, ¬´üóë –£–¥–∞–ª–∏—Ç—å¬ª.

## –†–∞–∑–¥–µ–ª ¬´üß© –¢–µ–º—ã¬ª
- –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–ø–∏—Å–∫–∞ —Ç–µ–º.
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π —Ç–µ–º—ã.
- –£–¥–∞–ª–µ–Ω–∏–µ —Ç–µ–º—ã —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤.

## –ú–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—è Telegram Stars

1. –ü—Ä–∏–º–µ–Ω–∏—Ç–µ SQL-–º–∏–≥—Ä–∞—Ü–∏—é `scripts/001_payments.sql` –≤ Supabase SQL Editor.
2. –í `.env` –µ—Å—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å `MONETIZATION_ENABLED`:
   - `false` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) ‚Äî –∫–Ω–æ–ø–∫–∏ –ø–æ–∫—É–ø–æ–∫ —Å–∫—Ä—ã—Ç—ã, `successful_payment` –Ω–µ –Ω–∞—á–∏—Å–ª—è–µ—Ç –¥–æ—Å—Ç—É–ø;
   - `true` ‚Äî –∫–Ω–æ–ø–∫–∏ –ø–æ–∫—É–ø–æ–∫ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ Stars-–ø–ª–∞—Ç–µ–∂–µ–π –≤–∫–ª—é—á–∞–µ—Ç—Å—è.
3. –ò–Ω–≤–æ–π—Å—ã Stars —Å–æ–∑–¥–∞—é—Ç—Å—è –≤ `buy_handler` (`src/bot.py`) —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º `invoice_payload`:
   - `PACK10` –¥–ª—è –ø–∞–∫–µ—Ç–∞ +10 (—Å—Ç–æ–∏–º–æ—Å—Ç—å –∏–∑ `PACK10_STARS`)
   - `UNLIMITED30` –¥–ª—è –±–µ–∑–ª–∏–º–∏—Ç–∞ 30 –¥–Ω–µ–π (—Å—Ç–æ–∏–º–æ—Å—Ç—å –∏–∑ `UNLIMITED30_STARS`)
4. –ù–∞—á–∏—Å–ª–µ–Ω–∏—è –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —á–µ—Ä–µ–∑ –µ–¥–∏–Ω—ã–π —Å–µ—Ä–≤–∏—Å `grant_purchase` (`src/logic/entitlements.py`):
   - –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–∞—è –∑–∞–ø–∏—Å—å –ø–ª–∞—Ç–µ–∂–∞ –≤ `public.payments` –ø–æ `telegram_payment_charge_id`
   - –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –ø–∞–∫–µ—Ç–∞ (`paid_packs_available + 1`) –∏–ª–∏ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ `subscriptions.unlimited_until` –Ω–∞ 30 –¥–Ω–µ–π
5. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –æ—Ç–∫—Ä—ã—Ç—å `/my_payments` (–∏–ª–∏ –∫–Ω–æ–ø–∫—É ¬´–ú–æ–∏ –ø–æ–∫—É–ø–∫–∏¬ª) –∏ —É–≤–∏–¥–µ—Ç—å –±–∞–ª–∞–Ω—Å –ø–∞–∫–µ—Ç–æ–≤, —Å—Ç–∞—Ç—É—Å –±–µ–∑–ª–∏–º–∏—Ç–∞ –∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –ø–ª–∞—Ç–µ–∂–∞.

## –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º –ø–ª–∞—Ç–µ–∂–µ–π

–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ü–µ–Ω–∞—Ä–∏—è —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã –±–µ–∑ Telegram Stars:

1. –í `.env` –≤–∫–ª—é—á–∏—Ç–µ —Ä–µ–∂–∏–º –∏ –∑–∞–¥–∞–π—Ç–µ –∞–¥–º–∏–Ω–æ–≤:

```env
TEST_MODE=true
ADMIN_TG_IDS=123456789,987654321
```

2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞.
3. –í Telegram (–ø–æ–¥ –∞–¥–º–∏–Ω-–∞–∫–∫–∞—É–Ω—Ç–æ–º) –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã:
   - `/test_pay_pack10` ‚Äî —Å–∏–º—É–ª–∏—Ä—É–µ—Ç –ø–æ–∫—É–ø–∫—É `PACK10`
   - `/test_pay_unlimited30` ‚Äî —Å–∏–º—É–ª–∏—Ä—É–µ—Ç –ø–æ–∫—É–ø–∫—É `UNLIMITED30`

–û–±–µ –∫–æ–º–∞–Ω–¥—ã –≤—ã–∑—ã–≤–∞—é—Ç —Ç–æ—Ç –∂–µ –æ–±—â–∏–π —Å–µ—Ä–≤–∏—Å –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è, —á—Ç–æ –∏ —Ä–µ–∞–ª—å–Ω–∞—è `successful_payment`, –ø–æ—ç—Ç–æ–º—É —Ç–µ—Å—Ç–æ–≤—ã–π –∏ –±–æ–µ–≤–æ–π —Ñ–ª–æ—É —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã.
